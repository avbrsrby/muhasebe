{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Cari Hareketler{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2>Cari Hareketler</h2>
        </div>
        <div class="col-md-6 text-end">
            <a href="{% url 'cari_hareket_ekle' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Yeni Hareket
            </a>
            <a href="{% url 'cari_virman' %}" class="btn btn-success">
                <i class="bi bi-arrow-left-right"></i> Cari Virman Hareketi
            </a>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Bugünkü İşlemler</h5>
                    <h3>{{ bugunki_islem_sayisi|default:0 }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Bugünkü Tahsilat</h5>
                    <h3 class="text-success">{{ bugunki_tahsilat|default:0|floatformat:2 }} TL</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Bugünkü Ödeme</h5>
                    <h3 class="text-danger">{{ bugunki_odeme|default:0|floatformat:2 }} TL</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Toplam İşlem</h5>
                    <h3>{{ toplam_islem_sayisi|default:0 }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreler -->
    <!-- Filtreler -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <!-- İlk satır -->
            <div class="col-md-3">
                <label class="form-label">Tarih Aralığı</label>
                <div class="input-group">
                    <input type="date" name="tarih_bas" class="form-control" value="{{ request.GET.tarih_bas }}">
                    <span class="input-group-text">-</span>
                    <input type="date" name="tarih_son" class="form-control" value="{{ request.GET.tarih_son }}">
                </div>
                <div class="btn-group btn-group-sm mt-2 w-100" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="setTarihBugun()">Bugün</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setTarihBuHafta()">Bu Hafta</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setTarihBuAy()">Bu Ay</button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cari</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="secilenCariText" placeholder="Cari seçiniz..."
                        value="{{ request.GET.cari_ara }}" readonly>
                    <input type="hidden" name="cari_ara" id="cari_ara_hidden" value="{{ request.GET.cari_ara }}">
                    <button type="button" class="btn btn-primary" onclick="cariSecListeFiltre()">
                        <i class="bi bi-search"></i> Cari Seç
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">İşlem Tipi</label>
                <select name="islem_tipi" class="form-select">
                    <option value="">Tümü</option>
                    <option value="nakit" {% if request.GET.islem_tipi == 'nakit' %}selected{% endif %}>Nakit</option>
                    <option value="banka" {% if request.GET.islem_tipi == 'banka' %}selected{% endif %}>Banka</option>
                    <option value="pos" {% if request.GET.islem_tipi == 'pos' %}selected{% endif %}>POS</option>
                    <option value="diger" {% if request.GET.islem_tipi == 'diger' %}selected{% endif %}>Diğer</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Hareket Yönü</label>
                <select name="hareket_yonu" class="form-select">
                    <option value="">Tümü</option>
                    <option value="giris" {% if request.GET.hareket_yonu == 'giris' %}selected{% endif %}>Giriş (Tahsilat)</option>
                    <option value="cikis" {% if request.GET.hareket_yonu == 'cikis' %}selected{% endif %}>Çıkış (Ödeme)</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Para Birimi</label>
                <select name="para_birimi" class="form-select">
                    <option value="">Tümü</option>
                    {% for pb in para_birimleri %}
                    <option value="{{ pb.id }}" {% if request.GET.para_birimi == pb.id|stringformat:"d" %}selected{% endif %}>
                        {{ pb.kod }} - {{ pb.ad }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- İkinci satır -->
            <div class="col-md-3">
                <label class="form-label">İşlemi Yapan</label>
                <select name="islem_yapan" class="form-select">
                    <option value="">Tümü</option>
                    {% for user in kullanicilar %}
                    <option value="{{ user.id }}" {% if request.GET.islem_yapan == user.id|stringformat:"d" %}selected{% endif %}>
                        {{ user.get_full_name|default:user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tutar Aralığı</label>
                <div class="input-group">
                    <input type="number" name="tutar_min" class="form-control" placeholder="Min" 
                        value="{{ request.GET.tutar_min }}" step="0.01" min="0">
                    <span class="input-group-text">-</span>
                    <input type="number" name="tutar_max" class="form-control" placeholder="Max" 
                        value="{{ request.GET.tutar_max }}" step="0.01" min="0">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Hesap</label>
                <select name="hesap" class="form-select">
                    <option value="">Tümü</option>
                    <optgroup label="KASALAR">
                        {% for kasa in kasalar %}
                        <option value="kasa-{{ kasa.id }}" title="{{ kasa.kod }} - {{ kasa.ad }}">
                            {{ kasa.kod }} - {{ kasa.ad|truncatechars:25 }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="BANKALAR">
                        {% for banka in bankalar %}
                        <option value="banka-{{ banka.id }}" title="{{ banka.kod }} - {{ banka.ad }}">
                            {{ banka.kod }} - {{ banka.ad|truncatechars:25 }}
                        </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <div class="btn-group w-100">
                    <button type="submit" class="btn btn-secondary">
                        <i class="bi bi-search"></i> Filtrele
                    </button>
                    <a href="{% url 'cari_hareket_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x"></i> Temizle
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Sayfa Boyutu Seçimi -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h5 class="mb-0">Hareket Listesi</h5>
    </div>
    <div>
        <select class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
            <option value="25" {% if request.GET.sayfa_boyutu == '25' %}selected{% endif %}>25 kayıt</option>
            <option value="50" {% if request.GET.sayfa_boyutu == '50' or not request.GET.sayfa_boyutu %}selected{% endif %}>50 kayıt</option>
            <option value="100" {% if request.GET.sayfa_boyutu == '100' %}selected{% endif %}>100 kayıt</option>
            <option value="all" {% if request.GET.sayfa_boyutu == 'all' %}selected{% endif %}>Tümü</option>
        </select>
    </div>
</div>

    <!-- Hareket Listesi -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tarih/Saat</th>
                            <th>Cari</th>
                            <th>İşlem Tipi</th>
                            <th>Hesap</th>
                            <th>Giriş</th>
                            <th>Çıkış</th>
                            <th>Para Birimi</th>
                            <th>Açıklama</th>
                            <th>İşlem Yapan</th>
                            <th width="100">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hareket in hareketler %}
                        <tr>
                            <td>{{ hareket.tarih|date:"d.m.Y H:i" }}</td>
                            <td>
                                <a href="{% url 'cari_hareketler' hareket.cari.pk %}" class="text-decoration-none">
                                    <span class="fs-5 fw-semibold text-dark">{{ hareket.cari.unvan }}</span>
                                </a>
                            </td>
                            <td>
                                {% if hareket.islem_tipi == 'virman' or 'Virman' in hareket.aciklama %}
                                <span class="badge bg-primary">Virman</span>
                                {% elif hareket.islem_tipi == 'nakit' %}
                                <span class="badge bg-success">{{ hareket.get_islem_tipi_display }}</span>
                                {% elif hareket.islem_tipi == 'banka' %}
                                <span class="badge bg-warning">{{ hareket.get_islem_tipi_display }}</span>
                                {% elif hareket.islem_tipi == 'pos' %}
                                <span class="badge bg-info">{{ hareket.get_islem_tipi_display }}</span>
                                {% else %}
                                <span class="badge bg-danger">{{ hareket.get_islem_tipi_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hareket.kasa %}
                                <i class="bi bi-cash"></i> {{ hareket.kasa.ad }}
                                {% elif hareket.banka %}
                                <i class="bi bi-bank"></i> {{ hareket.banka.ad }}
                                {% elif hareket.pos %}
                                <i class="bi bi-credit-card"></i> {{ hareket.pos.ad }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if hareket.hareket_yonu == 'giris' %}
                                <span class="text-success fw-bold">{{ hareket.tutar|floatformat:2 }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if hareket.hareket_yonu == 'cikis' %}
                                <span class="text-danger fw-bold">{{ hareket.tutar|floatformat:2 }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="text-center">{{ hareket.para_birimi.kod }}</td>
                            <td>
                                {% if hareket.aciklama %}
                                <small class="d-inline-block text-truncate" style="max-width: 200px;" title="{{ hareket.aciklama }}">
                                    {{ hareket.aciklama }}
                                </small>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                <small>{{ hareket.olusturan.get_full_name|default:hareket.olusturan.username }}</small>
                            </td>
                            <td class="text-center align-middle">
                                <div class="d-inline-flex justify-content-center">
                                    <a href="{% url 'cari_hareket_duzenle' hareket.id %}" class="btn btn-sm btn-warning"
                                        title="Düzenle">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>

                        <!-- Detay Modal -->
                        <div class="modal fade" id="detayModal{{ hareket.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Hareket Detayı</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>Tarih:</strong></div>
                                            <div class="col-8">{{ hareket.tarih|date:"d.m.Y H:i:s" }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>Cari:</strong></div>
                                            <div class="col-8">{{ hareket.cari.kod }} - {{ hareket.cari.unvan }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>İşlem:</strong></div>
                                            <div class="col-8">{{ hareket.get_islem_tipi_display }} - {{
                                                hareket.get_hareket_yonu_display }}</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>Tutar:</strong></div>
                                            <div class="col-8">{{ hareket.tutar|floatformat:2 }} {{
                                                hareket.para_birimi.kod }}</div>
                                        </div>
                                        {% if hareket.aciklama %}
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>Açıklama:</strong></div>
                                            <div class="col-8">{{ hareket.aciklama }}</div>
                                        </div>
                                        {% endif %}
                                        <hr>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>İşlem Yapan:</strong></div>
                                            <div class="col-8">{{
                                                hareket.olusturan.get_full_name|default:hareket.olusturan.username }}
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-4"><strong>Kayıt Tarihi:</strong></div>
                                            <div class="col-8">{{ hareket.olusturma_tarihi|date:"d.m.Y H:i:s" }}</div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Kapat</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center">Kayıt bulunamadı</td>
                        </tr>
                        {% endfor %}
                    
                    </tbody>
                    <tfoot>
                        <tr class="table-info fw-bold">
                            <td colspan="4">
                                <i class="bi bi-calculator"></i> Toplam: {{ hareketler.paginator.count|default:hareketler.count }} kayıt
                            </td>
                            <td class="text-center text-success">{{ toplam_giris|floatformat:2 }}</td>
                            <td class="text-center text-danger">{{ toplam_cikis|floatformat:2 }}</td>
                            <td colspan="4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Sayfalama -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <select class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                        <option value="25" {% if request.GET.sayfa_boyutu == '25' %}selected{% endif %}>25 kayıt</option>
                        <option value="50" {% if request.GET.sayfa_boyutu == '50' or not request.GET.sayfa_boyutu %}selected{% endif %}>50 kayıt</option>
                        <option value="100" {% if request.GET.sayfa_boyutu == '100' %}selected{% endif %}>100 kayıt</option>
                        <option value="all" {% if request.GET.sayfa_boyutu == 'all' %}selected{% endif %}>Tümü</option>
                    </select>
                </div>
                
                {% if hareketler.has_other_pages %}
                <nav>
                    <ul class="pagination mb-0">
                        {% if hareketler.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ hareketler.previous_page_number }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in hareketler.paginator.page_range %}
                            {% if hareketler.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > hareketler.number|add:'-3' and num < hareketler.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if hareketler.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ hareketler.next_page_number }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>


        </div>
    </div>
</div>

{% block extra_js %}
<script>
    $(document).ready(function () {

        // Hesap select'ini doğru değerle seç
        var hesapValue = "{{ request.GET.hesap }}";
        if (hesapValue) {
            $('select[name="hesap"]').val(hesapValue);
        }


        // Form elemanlarında değişiklik olduğunda otomatik submit
        $('input[name="tarih_bas"], input[name="tarih_son"], select[name="islem_tipi"], select[name="hareket_yonu"], select[name="para_birimi"], select[name="islem_yapan"], select[name="hesap"], input[name="tutar_min"], input[name="tutar_max"]').on('change', function () {
            $(this).closest('form').submit();
        });

        // Cari seç fonksiyonu
        window.cariSecListeFiltre = function () {
            // Global cari arama modal'ını aç
            var modalElement = document.getElementById('globalCariSearchModal');
            var modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modal.show();

            // Input'u temizle ve focus yap
            setTimeout(function () {
                $('#globalCariSearchInput').val('').focus();
                $('#globalCariSearchResults').html('');
            }, 100);

            // Cari seçildiğinde çalışacak fonksiyonu override et
            $(document).off('click', '.cari-select-item').on('click', '.cari-select-item', function (e) {
                e.preventDefault();

                var cari = {
                    id: $(this).data('id'),
                    kod: $(this).data('kod'),
                    unvan: $(this).data('unvan'),
                    bakiye: $(this).data('bakiye')
                };

                $('#secilenCariText').val(cari.unvan);
                $('#cari_ara_hidden').val(cari.unvan);

                modal.hide();

                // Formu submit et
                $('form').first().submit();
            });
        };

        

        // F5 tuşunu yakala ve cari seç fonksiyonunu çalıştır
        $(document).keydown(function (e) {
            if (e.key === 'F5' || e.keyCode === 116) {
                e.preventDefault(); // Sayfa yenilemeyi engelle
                cariSecListeFiltre(); // Cari seç fonksiyonunu çağır
                return false;
            }
        });

        // Temizle butonuna basıldığında cari alanını da temizle
        $('a[href="{% url "cari_hareket_list" %}"]').on('click', function (e) {
            $('#secilenCariText').val('');
            $('#cari_ara_hidden').val('');
        });
    });


    // Tarih fonksiyonları
    function setTarihBugun() {
        var today = new Date().toISOString().split('T')[0];
        $('input[name="tarih_bas"]').val(today);
        $('input[name="tarih_son"]').val(today);
        $('form').first().submit();
    }

    function setTarihBuHafta() {
        var today = new Date();
        var dayOfWeek = today.getDay();
        // Pazar günü 0 olduğu için Pazartesi'yi bulmak için ayarlama
        var monday = new Date(today);
        monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

        var mondayStr = monday.toISOString().split('T')[0];
        var todayStr = today.toISOString().split('T')[0];

        $('input[name="tarih_bas"]').val(mondayStr);
        $('input[name="tarih_son"]').val(todayStr);
        $('form').first().submit();
    }

    function setTarihBuAy() {
        var today = new Date();
        var year = today.getFullYear();
        var month = today.getMonth();

        // Yerel tarihi düzgün almak için
        var firstDayStr = year + '-' +
            String(month + 1).padStart(2, '0') + '-' +
            '01';

        var todayStr = today.getFullYear() + '-' +
            String(today.getMonth() + 1).padStart(2, '0') + '-' +
            String(today.getDate()).padStart(2, '0');

        $('input[name="tarih_bas"]').val(firstDayStr);
        $('input[name="tarih_son"]').val(todayStr);
        $('form').first().submit();
    }

    function changePageSize(size) {
        var url = new URL(window.location);
        url.searchParams.set('sayfa_boyutu', size);
        url.searchParams.delete('page'); // Sayfa numarasını sıfırla
        window.location = url;
    }



</script>
{% endblock %}


{% endblock %}