{% extends 'base_dashboard.html' %}

{% block title %}Cari Yönetimi{% endblock %}

{% block content %}
<h1>Cari Yönetimi</h1>

<!-- Filtre Paneli -->
<div class="card mb-3">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtreler</h5>
            <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <i class="bi bi-chevron-down"></i> Göster/Gizle
            </button>
        </div>
    </div>
    <div class="collapse show" id="filterPanel">
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row">
                    <!-- Genel Arama -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Genel Arama</label>
                        <input type="text" class="form-control" name="arama" 
                               placeholder="Ünvan, Kod, Yetkili, Vergi No..." 
                               value="{{ filters.arama|default:'' }}">
                    </div>
                    
                    <!-- Grup -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Cari Grubu</label>
                        <select class="form-control" name="grup">
                            <option value="">Tümü</option>
                            {% for grup in gruplar %}
                                <option value="{{ grup.id }}" {% if filters.grup == grup.id|stringformat:"s" %}selected{% endif %}>
                                    {{ grup.ad }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Durum -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Durum</label>
                        <select class="form-control" name="durum">
                            <option value="">Tümü</option>
                            <option value="aktif" {% if filters.durum == 'aktif' %}selected{% endif %}>Aktif</option>
                            <option value="pasif" {% if filters.durum == 'pasif' %}selected{% endif %}>Pasif</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- İl -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">İl</label>
                        <select class="form-control" name="il" id="filter_il">
                            <option value="">Tümü</option>
                            {% for il in iller %}
                                <option value="{{ il.id }}" {% if filters.il == il.id|stringformat:"s" %}selected{% endif %}>
                                    {{ il.ad }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- İlçe -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">İlçe</label>
                        <select class="form-control" name="ilce" id="filter_ilce">
                            <option value="">Tümü</option>
                            {% if filters.ilceler %}
                                {% for ilce in filters.ilceler %}
                                    <option value="{{ ilce.id }}" {% if filters.ilce == ilce.id|stringformat:"s" %}selected{% endif %}>
                                        {{ ilce.ad }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Firma Tipi -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Firma Tipi</label>
                        <select class="form-control" name="firma_tipi">
                            <option value="">Tümü</option>
                            <option value="sahis" {% if filters.firma_tipi == 'sahis' %}selected{% endif %}>Şahıs</option>
                            <option value="sirket" {% if filters.firma_tipi == 'sirket' %}selected{% endif %}>Şirket</option>
                        </select>
                    </div>
                    
                    <!-- Bakiye Durumu -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Bakiye Durumu</label>
                        <select class="form-control" name="bakiye_durum">
                            <option value="">Tümü</option>
                            <option value="borclu" {% if filters.bakiye_durum == 'borclu' %}selected{% endif %}>Borçlu</option>
                            <option value="alacakli" {% if filters.bakiye_durum == 'alacakli' %}selected{% endif %}>Alacaklı</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Bakiye Aralığı -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Min. Bakiye</label>
                        <input type="number" class="form-control" name="bakiye_min" 
                               placeholder="0.00" step="0.01"
                               value="{{ filters.bakiye_min|default:'' }}">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Max. Bakiye</label>
                        <input type="number" class="form-control" name="bakiye_max" 
                               placeholder="0.00" step="0.01"
                               value="{{ filters.bakiye_max|default:'' }}">
                    </div>
                    
                    <!-- Sıralama -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Sıralama</label>
                        <select class="form-control" name="siralama">
                            <option value="kod" {% if filters.siralama == 'kod' %}selected{% endif %}>Kod</option>
                            <option value="unvan" {% if filters.siralama == 'unvan' %}selected{% endif %}>Ünvan</option>
                            <option value="bakiye_artan" {% if filters.siralama == 'bakiye_artan' %}selected{% endif %}>Bakiye (Artan)</option>
                            <option value="bakiye_azalan" {% if filters.siralama == 'bakiye_azalan' %}selected{% endif %}>Bakiye (Azalan)</option>
                        </select>
                    </div>
                    
                    <!-- Butonlar -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filtrele
                            </button>
                            <a href="{% url 'cari_list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Temizle
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Özet Bilgiler -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6>Toplam Borç</h6>
                <h4>{{ toplam_borc|floatformat:2 }} ₺</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6>Toplam Alacak</h6>
                <h4>{{ toplam_alacak|floatformat:2 }} ₺</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6>Net Bakiye</h6>
                <h4>{{ bakiye_net|floatformat:2 }} ₺</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6>Toplam Cari</h6>
                <h4>{{ cariler.count }} Adet</h4>
            </div>
        </div>
    </div>
</div>

<!-- Tab Menü -->
<ul class="nav nav-tabs" id="cariTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="cari-list-tab" data-bs-toggle="tab" data-bs-target="#cari-list" type="button">
            <i class="bi bi-people"></i> Cari Listesi
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="cari-grup-tab" data-bs-toggle="tab" data-bs-target="#cari-grup" type="button">
            <i class="bi bi-folder"></i> Cari Grupları
        </button>
    </li>
</ul>

<!-- Tab İçerikleri -->
<div class="tab-content" id="cariTabContent">
    <!-- Cari Listesi Tab'ı -->
    <div class="tab-pane fade show active" id="cari-list" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Cari Listesi ({{ cariler.count }} kayıt)</h5>
                    <a href="{% url 'cari_ekle' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Yeni Cari Ekle
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Kod</th>
                                <th>Ünvan</th>
                                <th>Grup</th>
                                <th>Yetkili</th>
                                <th>Telefon</th>
                                <th>İl/İlçe</th>
                                <th>Bakiye</th>
                                <th>Durum</th>
                                <th width="120">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cari in cariler %}
                            <tr>
                                <td><strong>{{ cari.kod }}</strong></td>
                                <td>{{ cari.unvan }}</td>
                                <td>
                                    {% if cari.grup %}
                                        <span class="badge bg-secondary">{{ cari.grup.ad }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ cari.yetkili_adi|default:'-' }}</td>
                                <td>{{ cari.yetkili_tel1|default:cari.telefon|default:'-' }}</td>
                                <td>
                                    {% if cari.il %}
                                        {{ cari.il.ad }}{% if cari.ilce %}/{{ cari.ilce.ad }}{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-{% if cari.bakiye < 0 %}danger{% elif cari.bakiye > 0 %}success{% else %}muted{% endif %}">
                                        {{ cari.bakiye|floatformat:2 }} ₺
                                    </span>
                                </td>
                                <td>
                                    {% if cari.aktif %}
                                        <span class="badge bg-success">Aktif</span>
                                    {% else %}
                                        <span class="badge bg-danger">Pasif</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'cari_detay' cari.pk %}" class="btn btn-sm btn-info" title="Detay">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'cari_duzenle' cari.pk %}" class="btn btn-sm btn-warning" title="Düzenle">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">
                                    {% if filters %}
                                        Filtrelere uygun kayıt bulunamadı.
                                    {% else %}
                                        Henüz cari kart bulunmamaktadır.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Cari Grupları Tab'ı (mevcut kodunuz) -->
    <div class="tab-pane fade" id="cari-grup" role="tabpanel">
        <!-- Mevcut grup yönetimi kodları -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// İl değiştiğinde ilçeleri yükle
document.getElementById('filter_il').addEventListener('change', function() {
    var ilId = this.value;
    var ilceSelect = document.getElementById('filter_ilce');
    
    // İlçe seçimini temizle
    ilceSelect.innerHTML = '<option value="">Tümü</option>';
    
    if (ilId) {
        // AJAX ile ilçeleri getir
        fetch(`/ajax/ilceler/${ilId}/`)
            .then(response => response.json())
            .then(data => {
                data.ilceler.forEach(function(ilce) {
                    var option = document.createElement('option');
                    option.value = ilce.id;
                    option.textContent = ilce.ad;
                    ilceSelect.appendChild(option);
                });
            });
    }
});
</script>
{% endblock %}