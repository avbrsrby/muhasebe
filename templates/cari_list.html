{% extends 'base_dashboard.html' %}

{% block title %}Cari Yönetimi{% endblock %}

{% block content %}
<h1>Cari Yönetimi</h1>

<!-- Filtre Paneli -->
<div class="card mb-3">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtreler</h5>
            <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <i class="bi bi-chevron-down"></i> Göster/Gizle
            </button>
        </div>
    </div>
    <div class="collapse show" id="filterPanel">
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row">
                    <!-- Genel Arama -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">
                            Genel Arama 
                            <i class="bi bi-info-circle text-primary" 
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="Arama yapılan alanlar: Ünvan, Cari Kodu, Yetkili Adı, Vergi No, TC Kimlik No, Telefon, E-posta, Adres"
                            style="cursor: help;">
                            </i>
                        </label>
                        <input type="text" class="form-control" name="cari_ara" 
                            placeholder="Ünvan, Kod, Yetkili, Vergi No..." 
                            value="{{ filters.arama|default:'' }}">
                    </div>
                    
                    <!-- Grup -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Cari Grubu</label>
                        <select class="form-control" name="grup">
                            <option value="">Tümü</option>
                            {% for grup in gruplar %}
                                <option value="{{ grup.id }}" {% if filters.grup == grup.id|stringformat:"s" %}selected{% endif %}>
                                    {{ grup.ad }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Durum -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Durum</label>
                        <select class="form-control" name="durum">
                            <option value="">Tümü</option>
                            <option value="aktif" {% if filters.durum == 'aktif' %}selected{% endif %}>Aktif</option>
                            <option value="pasif" {% if filters.durum == 'pasif' %}selected{% endif %}>Pasif</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- İl -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">İl</label>
                        <select class="form-control" name="il" id="filter_il">
                            <option value="">Tümü</option>
                            {% for il in iller %}
                                <option value="{{ il.id }}" {% if filters.il == il.id|stringformat:"s" %}selected{% endif %}>
                                    {{ il.ad }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- İlçe -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">İlçe</label>
                        <select class="form-control" name="ilce" id="filter_ilce">
                            <option value="">Tümü</option>
                            {% if filters.ilceler %}
                                {% for ilce in filters.ilceler %}
                                    <option value="{{ ilce.id }}" {% if filters.ilce == ilce.id|stringformat:"s" %}selected{% endif %}>
                                        {{ ilce.ad }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <!-- Firma Tipi -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Firma Tipi</label>
                        <select class="form-control" name="firma_tipi">
                            <option value="">Tümü</option>
                            <option value="sahis" {% if filters.firma_tipi == 'sahis' %}selected{% endif %}>Şahıs</option>
                            <option value="sirket" {% if filters.firma_tipi == 'sirket' %}selected{% endif %}>Şirket</option>
                        </select>
                    </div>
                    
                    <!-- Bakiye Durumu -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Bakiye Durumu</label>
                        <select class="form-control" name="bakiye_durum">
                            <option value="">Tümü</option>
                            <option value="borclu" {% if filters.bakiye_durum == 'borclu' %}selected{% endif %}>Borçlu</option>
                            <option value="alacakli" {% if filters.bakiye_durum == 'alacakli' %}selected{% endif %}>Alacaklı</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Bakiye Aralığı -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Min. Bakiye</label>
                        <input type="number" class="form-control" name="bakiye_min" 
                               placeholder="0.00" step="0.01"
                               value="{{ filters.bakiye_min|default:'' }}">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Max. Bakiye</label>
                        <input type="number" class="form-control" name="bakiye_max" 
                               placeholder="0.00" step="0.01"
                               value="{{ filters.bakiye_max|default:'' }}">
                    </div>
                    
                    <!-- Sıralama -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Sıralama</label>
                        <select class="form-control" name="siralama">
                            <option value="unvan" {% if filters.siralama == 'unvan' %}selected{% endif %}>Ünvan</option>
                            <option value="bakiye_azalan" {% if filters.siralama == 'bakiye_azalan' or not filters.siralama %}selected{% endif %}>Bakiye (Yüksekten Düşüğe)</option>
                            <option value="bakiye_artan" {% if filters.siralama == 'bakiye_artan' %}selected{% endif %}>Bakiye (Düşükten Yükseğe)</option>
                        </select>
                    </div>
                    
                    <!-- Butonlar -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Filtrele
                            </button>
                            <a href="{% url 'cari_list' %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Temizle
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div><h4  style="text-align: center;">Seçilen filtrelere göre toplam bakiye bilgileri:</h4></div>

<!-- Özet Bilgiler -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6>Toplam Çıkış</h6>
                <h4>{{ toplam_borc|floatformat:2 }} ₺</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6>Toplam Giriş</h6>
                <h4>{{ toplam_alacak|floatformat:2 }} ₺</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6>Net Bakiye</h6>
                <h4>{{ bakiye_net|floatformat:2 }} ₺</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6>Toplam Cari</h6>
                <h4>{{ cariler.count }} Adet</h4>
            </div>
        </div>
    </div>
</div>

<!-- Tab Menü -->
<ul class="nav nav-tabs" id="cariTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="cari-list-tab" data-bs-toggle="tab" data-bs-target="#cari-list" type="button">
            <i class="bi bi-people"></i> Cari Listesi
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="cari-grup-tab" data-bs-toggle="tab" data-bs-target="#cari-grup" type="button">
            <i class="bi bi-folder"></i> Cari Grupları
        </button>
    </li>
</ul>

<!-- Tab İçerikleri -->
<div class="tab-content" id="cariTabContent">
    <!-- Cari Listesi Tab'ı -->
    <div class="tab-pane fade show active" id="cari-list" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Cari Listesi ({{ cariler.count }} kayıt)</h5>
                    <a href="{% url 'cari_ekle' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Yeni Cari Ekle
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Kod</th>
                                <th>Ünvan</th>
                                <th>Grup</th>
                                <th>Yetkili</th>
                                <th>Telefon</th>
                                <th>İl/İlçe</th>
                                <th>Bakiye (TL)</th>
                                <th>Durum</th>
                                <th width="120">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cari in cariler %}
                            <tr>
                                <td><strong>{{ cari.kod }}</strong></td>
                                <td>{{ cari.unvan }}</td>
                                <td>
                                    {% if cari.grup %}
                                        <span class="badge bg-secondary">{{ cari.grup.ad }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ cari.yetkili_adi|default:'-' }}</td>
                                <td>{{ cari.yetkili_tel1|default:cari.telefon|default:'-' }}</td>
                                <td>
                                    {% if cari.il %}
                                        {{ cari.il.ad }}{% if cari.ilce %}/{{ cari.ilce.ad }}{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                               <td class="{% if cari.bakiye_hesaplanan > 0 %}text-success{% elif cari.bakiye_hesaplanan < 0 %}text-danger{% endif %}">
                                    <strong>{{ cari.bakiye_hesaplanan|default:cari.bakiye|floatformat:2 }} TL</strong>
                                </td>
                                <td>
                                    {% if cari.aktif %}
                                        <span class="badge bg-success">Aktif</span>
                                    {% else %}
                                        <span class="badge bg-danger">Pasif</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'cari_detay' cari.pk %}" class="btn btn-sm btn-info" title="Detay">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'cari_duzenle' cari.pk %}" class="btn btn-sm btn-warning" title="Düzenle">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">
                                    {% if filters %}
                                        Filtrelere uygun kayıt bulunamadı.
                                    {% else %}
                                        Henüz cari kart bulunmamaktadır.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Cari Grupları Tab'ı -->
<div class="tab-pane fade" id="cari-grup" role="tabpanel">
    <div class="card mt-3">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>Yeni Grup Ekle</h5>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'cari_grup_list' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">Grup Adı</label>
                                    <input type="text" name="ad" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Üst Grup</label>
                                    <select name="ust_grup" class="form-control">
                                        <option value="">Ana Grup</option>
                                        {% for grup in gruplar %}
                                            <option value="{{ grup.id }}">{{ grup.ad }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="text-muted">Ana grup için boş bırakın</small>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-plus-circle"></i> Grup Ekle
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>Mevcut Gruplar</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Kod</th>
                                            <th>Grup Adı</th>
                                            <th>Üst Grup</th>
                                            <th>Seviye</th>
                                            <th width="120">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for grup in gruplar %}
                                        <tr>
                                            <td>{{ grup.kod }}</td>
                                            <td>
                                                {% if grup.seviye == 2 %}
                                                    &nbsp;&nbsp;&nbsp;&nbsp;└─ {{ grup.ad }}
                                                {% elif grup.seviye == 3 %}
                                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└─ {{ grup.ad }}
                                                {% else %}
                                                    <strong>{{ grup.ad }}</strong>
                                                {% endif %}
                                            </td>
                                            <td>{{ grup.ust_grup.ad|default:'-' }}</td>
                                            <td>
                                                {% if grup.seviye == 1 %}
                                                    <span class="badge bg-primary">Ana Grup</span>
                                                {% elif grup.seviye == 2 %}
                                                    <span class="badge bg-success">Ara Grup</span>
                                                {% else %}
                                                    <span class="badge bg-info">Alt Grup</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'cari_grup_duzenle' grup.pk %}" class="btn btn-sm btn-warning">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a href="{% url 'cari_grup_sil' grup.pk %}" 
                                                    class="btn btn-sm btn-danger"
                                                    onclick="return confirm('Bu grubu silmek istediğinize emin misiniz?')">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center">Henüz grup tanımlanmamış.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// İl değiştiğinde ilçeleri yükle
document.getElementById('filter_il').addEventListener('change', function() {
    var ilId = this.value;
    var ilceSelect = document.getElementById('filter_ilce');
    
    // İlçe seçimini temizle
    ilceSelect.innerHTML = '<option value="">Tümü</option>';
    
    if (ilId) {
        // AJAX ile ilçeleri getir
        fetch(`/ajax/ilceler/${ilId}/`)
            .then(response => response.json())
            .then(data => {
                data.ilceler.forEach(function(ilce) {
                    var option = document.createElement('option');
                    option.value = ilce.id;
                    option.textContent = ilce.ad;
                    ilceSelect.appendChild(option);
                });
            });
    }
});


// Otomatik filtreleme için
$(document).ready(function() {

    // F5 ile cari seçildiğinde otomatik filtreleme
$(document).on('input change', '[name="cari_ara"]', function() {
    // Eğer değer F5 modalından geliyorsa (programatik değişim)
    if ($(this).data('from-modal')) {
        $('#filterForm').submit();
        $(this).data('from-modal', false);
    }
});

// Global cari modal kapatıldığında kontrol et
$('#globalCariSearchModal').on('hide.bs.modal', function() {
    if ($('[name="cari_ara"]').val()) {
        $('[name="cari_ara"]').data('from-modal', true).trigger('change');
    }
});



    // Form elemanları değiştiğinde otomatik submit
    $('#filterForm select, #filterForm input[type="text"], #filterForm input[type="number"]').on('change', function() {
        // İl değiştiğinde ilçe yüklenene kadar bekle
        if ($(this).attr('id') === 'filter_il') {
            setTimeout(function() {
                $('#filterForm').submit();
            }, 500);
        } else {
            $('#filterForm').submit();
        }
    });
    
    // Text inputlar için debounce ekleyelim (yazma bitince filtrele)
    var timeout;
    $('#filterForm input[type="text"]').on('keyup', function() {
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            $('#filterForm').submit();
        }, 500); // 500ms bekle
    });
    
    // Number inputlar için
    $('#filterForm input[type="number"]').on('keyup', function() {
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            $('#filterForm').submit();
        }, 500);
    });
});



</script>
{% endblock %}