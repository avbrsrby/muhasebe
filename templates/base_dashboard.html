<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Muhasebe Sistemi{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .list-group-item.active {
            background-color: #0d6efd;
            color: white;
        }

        .list-group-item.active .text-muted {
            color: #ccc !important;
        }

        .list-group-item.active .badge {
            background-color: white !important;
            color: #0d6efd !important;
        }

        .list-group-item.active .text-primary {
            color: white !important;
        }

        .list-group-item.active .text-success {
            color: #90ee90 !important;
        }

        .list-group-item.active .text-danger {
            color: #ffcccb !important;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'anasayfa' %}">
                <i class="bi bi-calculator"></i> Muhasebe Sistemi
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'anasayfa' %}">
                            <i class="bi bi-house"></i> Ana Sayfa
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'cari_list' %}">
                            <i class="bi bi-people"></i> Cariler
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'cari_hareket_list' %}">
                            <i class="bi bi-arrow-left-right"></i> Cari Hareket
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'stok_list' %}">
                            <i class="bi bi-box"></i> Stok
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'stok_grup_list' %}">
                            <i class="bi bi-diagram-3"></i> Stok Grupları
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'fatura_list' %}">
                            <i class="bi bi-receipt"></i> Faturalar
                        </a>
                    </li>
                    {% if user.is_superuser %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'yetkili_menu' %}">
                            <i class="bi bi-gear-fill"></i> Yetkili
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-warning" href="{% url 'silinen_kayitlar' %}">
                            <i class="bi bi-trash3"></i> Silinen Kayıtlar
                            {% load static %}
                            {% with total_deleted=0 %}
                            {% if user.is_superuser %}
                            {% with 'muhasebe.models.CariKart' as cari_model %}
                            {% with 'muhasebe.models.CariGrup' as grup_model %}
                            {% with 'muhasebe.models.StokKart' as stok_model %}
                            {% with 'muhasebe.models.CariHareket' as hareket_model %}
                            <span class="badge bg-danger" id="silinen-sayisi"></span>
                            <script>
                                // AJAX ile silinen kayıt sayısını al
                                fetch("{% url 'silinen_kayitlar' %}")
                                    .then(response => response.text())
                                    .then(html => {
                                        const parser = new DOMParser();
                                        const doc = parser.parseFromString(html, 'text/html');

                                        let toplam = 0;
                                        const tabs = doc.querySelectorAll('.nav-tabs button');
                                        tabs.forEach(tab => {
                                            const match = tab.textContent.match(/\((\d+)\)/);
                                            if (match) {
                                                toplam += parseInt(match[1]);
                                            }
                                        });

                                        const badge = document.getElementById('silinen-sayisi');
                                        if (toplam > 0) {
                                            badge.textContent = toplam;
                                            badge.style.display = 'inline-block';
                                        } else {
                                            badge.style.display = 'none';
                                        }
                                    });
                            </script>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                            {% endif %}
                            {% endwith %}
                        </a>
                    </li>
                    {% endif %}


                </ul>
                <!-- Navbar içinde, </ul> kapanışından önce -->
                </ul>
                <ul class="navbar-nav">
                    <!-- Döviz Kurları -->
                    <li class="nav-item">
                        <span class="navbar-text me-3">
                            <span class="text-white-50 me-2">TCMB Döviz Kurları:</span>
                            {% if doviz_kurlari.USD %}
                            <i class="bi bi-currency-dollar text-success"></i>
                            <span class="badge bg-success">{{ doviz_kurlari.USD|floatformat:4 }}</span>
                            {% else %}
                            <i class="bi bi-currency-dollar"></i>
                            <span class="badge bg-secondary">--</span>
                            {% endif %}

                            {% if doviz_kurlari.EUR %}
                            <i class="bi bi-currency-euro text-primary ms-2"></i>
                            <span class="badge bg-primary">{{ doviz_kurlari.EUR|floatformat:4 }}</span>
                            {% else %}
                            <i class="bi bi-currency-euro ms-2"></i>
                            <span class="badge bg-secondary">--</span>
                            {% endif %}
                        </span>
                    </li>

                    <li class="nav-item">
                        <span class="navbar-text text-white me-3">
                            <i class="bi bi-info-circle"></i> F5: Cari Ara | F6: Stok Ara
                        </span>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                    <i class="bi bi-box-arrow-right"></i> Çıkış
                                </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="container mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Content -->
    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- Global Cari Arama Modal -->
    <div class="modal fade" id="globalCariSearchModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cari Ara</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="globalCariSearchInput"
                            placeholder="Cari kodu veya ünvanı yazın..." autofocus autocomplete="off">
                        <small class="text-muted">En az 2 karakter girin</small>
                    </div>
                    <div id="globalCariSearchResults" style="max-height: 400px; overflow-y: auto;">
                        <!-- Sonuçlar buraya gelecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Global Stok Arama Modal -->
    <div class="modal fade" id="globalStokSearchModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stok Ara</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="globalStokSearchInput"
                            placeholder="Stok kodu, adı veya barkod yazın..." autofocus autocomplete="off">
                        <small class="text-muted">En az 2 karakter girin</small>
                    </div>
                    <div id="globalStokSearchResults" style="max-height: 400px; overflow-y: auto;">
                        <!-- Sonuçlar buraya gelecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Global Cari Arama Script -->
    <script>
        $(document).ready(function () {
            var globalCariSearchModal = new bootstrap.Modal(document.getElementById('globalCariSearchModal'));
            var selectedCariCallback = null;
            var searchTimeout = null;

            // F5 ve F2 tuşları için global event listener
            $(document).keydown(function (e) {
                // F5 - Cari Arama
                if (e.key === 'F5' || e.keyCode === 116) {
                    e.preventDefault(); // Sayfa yenilemeyi engelle

                    // Modal'ı aç
                    globalCariSearchModal.show();

                    // Input'u temizle ve focus yap
                    setTimeout(function () {
                        $('#globalCariSearchInput').val('').focus();
                        $('#globalCariSearchResults').html('');
                    }, 100);

                    // Callback'i ayarla
                    selectedCariCallback = function (cari) {
                        // Cari seçim inputu var mı kontrol et
                        if ($('#id_cari').length > 0) {
                            // Select2 varsa
                            if ($('#id_cari').hasClass('select2-hidden-accessible')) {
                                var newOption = new Option(cari.kod + ' - ' + cari.unvan, cari.id, true, true);
                                $('#id_cari').append(newOption).trigger('change');
                                $('#id_cari').trigger({
                                    type: 'select2:select',
                                    params: {
                                        data: {
                                            id: cari.id,
                                            text: cari.kod + ' - ' + cari.unvan,
                                            bakiye: cari.bakiye
                                        }
                                    }
                                });
                            } else {
                                // Normal select
                                $('#id_cari').val(cari.id);
                            }
                        }

                        // Cari arama inputu varsa (text input)
                        if ($('[name="cari_ara"]').length > 0) {
                            $('[name="cari_ara"]').val(cari.unvan);
                        }
                    };

                    return false;
                }



                // F6 - Stok Arama
                if (e.key === 'F6' || e.keyCode === 117) {
                    e.preventDefault(); // Varsayılan davranışı engelle

                    // Stok modal'ını aç
                    var globalStokSearchModal = new bootstrap.Modal(document.getElementById('globalStokSearchModal'));
                    globalStokSearchModal.show();

                    // Input'u temizle ve focus yap
                    setTimeout(function () {
                        $('#globalStokSearchInput').val('').focus();
                        $('#globalStokSearchResults').html('');
                    }, 100);

                    return false;
                }

                // F2 - Filtreleme
                if (e.key === 'F2' || e.keyCode === 113) {
                    e.preventDefault();

                    // Sayfada filtre formu var mı kontrol et
                    var filterForm = $('form').filter(function () {
                        return $(this).find('button[type="submit"]').text().indexOf('Filtrele') > -1 ||
                            $(this).find('button[type="submit"] i.bi-search').length > 0;
                    });

                    if (filterForm.length > 0) {
                        // İlk filtre formunu submit et
                        filterForm.first().submit();
                    }

                    return false;
                }
            });

            // Arama input'una yazıldığında
            $('#globalCariSearchInput').on('input', function () {
                selectedCariIndex = -1;
                var query = $(this).val();

                // Önceki timeout'u iptal et
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                if (query.length < 2) {
                    $('#globalCariSearchResults').html('<div class="alert alert-info">En az 2 karakter girin</div>');
                    return;
                }

                // Yeni arama için timeout
                searchTimeout = setTimeout(function () {
                    $('#globalCariSearchResults').html('<div class="text-center"><div class="spinner-border" role="status"></div></div>');

                    $.ajax({
                        url: '{% url "cari_ara" %}',
                        data: { q: query },
                        success: function (data) {
                            var html = '';

                            if (data.results.length === 0) {
                                html = '<div class="alert alert-warning">Sonuç bulunamadı</div>';
                            } else {
                                html = '<div class="list-group">';
                                $.each(data.results, function (index, item) {
                                    var bakiyeClass = parseFloat(item.bakiye) < 0 ? 'text-danger' :
                                        (parseFloat(item.bakiye) > 0 ? 'text-success' : 'text-secondary');

                                    html += '<a href="#" class="list-group-item list-group-item-action cari-select-item" ' +
                                        'data-id="' + item.id + '" ' +
                                        'data-kod="' + (item.kod || '') + '" ' +
                                        'data-unvan="' + (item.unvan || item.text.split(' - ')[1] || '') + '" ' +
                                        'data-bakiye="' + item.bakiye + '">' +
                                        '<div class="d-flex justify-content-between align-items-center">' +
                                        '<div>' +
                                        '<strong>' + (item.kod || item.text.split(' - ')[0]) + '</strong> - ' +
                                        (item.unvan || item.text.split(' - ')[1] || '') +
                                        '</div>' +
                                        '<span class="' + bakiyeClass + ' fw-bold">' +
                                        parseFloat(item.bakiye).toFixed(2) + ' TL</span>' +
                                        '</div>' +
                                        '</a>';
                                });
                                html += '</div>';
                            }

                            $('#globalCariSearchResults').html(html);
                        },
                        error: function () {
                            $('#globalCariSearchResults').html('<div class="alert alert-danger">Bir hata oluştu</div>');
                        }
                    });
                }, 300); // 300ms bekle
            });

            // Cari seçildiğinde
            $(document).on('click', '.cari-select-item', function (e) {
                e.preventDefault();

                var cari = {
                    id: $(this).data('id'),
                    kod: $(this).data('kod'),
                    unvan: $(this).data('unvan'),
                    bakiye: $(this).data('bakiye')
                };

                // Callback'i çağır
                if (selectedCariCallback) {
                    selectedCariCallback(cari);
                }

                // Modal'ı kapat
                globalCariSearchModal.hide();
            });

            // Modal açıldığında input'a focus - BOOTSTRAP EVENT KULLAN
            document.getElementById('globalCariSearchModal').addEventListener('shown.bs.modal', function () {
                $('#globalCariSearchInput').focus();
            });

            // Klavye navigasyonu için değişken
            var selectedCariIndex = -1;

            // Enter ve yön tuşları için keydown eventi
            $('#globalCariSearchInput').on('keydown', function (e) {
                var items = $('.cari-select-item');

                if (e.which === 13) { // Enter
                    e.preventDefault();
                    if (selectedCariIndex >= 0 && items.length > 0) {
                        items.eq(selectedCariIndex).click();
                    } else if (items.length > 0) {
                        items.first().click();
                    }
                } else if (e.which === 38) { // Yukarı ok
                    e.preventDefault();
                    if (selectedCariIndex > 0) {
                        selectedCariIndex--;
                        updateCariSelection(items);
                    }
                } else if (e.which === 40) { // Aşağı ok
                    e.preventDefault();
                    if (selectedCariIndex < items.length - 1) {
                        selectedCariIndex++;
                        updateCariSelection(items);
                    }
                }
            });

            // Seçimi güncelle
            function updateCariSelection(items) {
                items.removeClass('active');
                if (selectedCariIndex >= 0) {
                    items.eq(selectedCariIndex).addClass('active');
                    // Görünür alanda tut
                    var container = $('#globalCariSearchResults');
                    var item = items.eq(selectedCariIndex);
                    var itemTop = item.position().top;
                    var itemBottom = itemTop + item.outerHeight();
                    var containerHeight = container.height();
                    var scrollTop = container.scrollTop();

                    if (itemBottom > containerHeight) {
                        container.scrollTop(scrollTop + itemBottom - containerHeight);
                    } else if (itemTop < 0) {
                        container.scrollTop(scrollTop + itemTop);
                    }
                }
            }



            // Global Stok Arama
            var globalStokSearchModal = new bootstrap.Modal(document.getElementById('globalStokSearchModal'));
            var selectedStokCallback = null;
            var stokSearchTimeout = null;

            // Klavye navigasyonu için değişken
            var selectedStokIndex = -1;

            // Stok arama input'una yazıldığında
            $('#globalStokSearchInput').on('input', function () {
                selectedStokIndex = -1;
                var query = $(this).val();


                // Önceki timeout'u iptal et
                if (stokSearchTimeout) {
                    clearTimeout(stokSearchTimeout);
                }

                if (query.length < 2) {
                    $('#globalStokSearchResults').html('<div class="alert alert-info">En az 2 karakter girin</div>');
                    return;
                }

                // Yeni arama için timeout
                stokSearchTimeout = setTimeout(function () {
                    $('#globalStokSearchResults').html('<div class="text-center"><div class="spinner-border" role="status"></div></div>');

                    $.ajax({
                        url: '{% url "stok_ara" %}',
                        data: { q: query },
                        success: function (data) {
                            var html = '';

                            if (data.results.length === 0) {
                                html = '<div class="alert alert-warning">Sonuç bulunamadı</div>';
                            } else {
                                html = '<div class="list-group">';
                                $.each(data.results, function (index, item) {
                                    html += '<a href="#" class="list-group-item list-group-item-action stok-select-item" ' +
                                        'data-id="' + item.id + '" ' +
                                        'data-kod="' + item.kod + '" ' +
                                        'data-ad="' + item.ad + '" ' +
                                        'data-barkod="' + item.barkod + '" ' +
                                        'data-birim="' + item.birim + '" ' +
                                        'data-stok-miktari="' + item.stok_miktari + '" ' +
                                        'data-satis-fiyati="' + item.satis_fiyati + '" ' +
                                        'data-para-birimi="' + item.para_birimi + '">' +
                                        '<div class="d-flex justify-content-between">' +
                                        '<div>' +
                                        '<strong>' + item.kod + '</strong> - ' + item.ad +
                                        (item.barkod ? ' <small class="text-muted">(Barkod: ' + item.barkod + ')</small>' : '') +
                                        '</div>' +
                                        '<div class="text-end">' +
                                        '<span class="badge bg-secondary">' + item.stok_miktari + ' ' + item.birim + '</span> ' +
                                        '<span class="text-primary fw-bold">' + item.satis_fiyati + ' ' + item.para_birimi + '</span>' +
                                        '</div>' +
                                        '</div>' +
                                        '</a>';
                                });
                                html += '</div>';
                            }

                            $('#globalStokSearchResults').html(html);
                        },
                        error: function () {
                            $('#globalStokSearchResults').html('<div class="alert alert-danger">Bir hata oluştu</div>');
                        }
                    });
                }, 300); // 300ms bekle
            });

            // Stok seçildiğinde
            $(document).on('click', '.stok-select-item', function (e) {
                e.preventDefault();

                var stok = {
                    id: $(this).data('id'),
                    kod: $(this).data('kod'),
                    ad: $(this).data('ad'),
                    barkod: $(this).data('barkod'),
                    birim: $(this).data('birim'),
                    stok_miktari: $(this).data('stok-miktari'),
                    satis_fiyati: $(this).data('satis-fiyati'),
                    para_birimi: $(this).data('para-birimi')
                };

                // Eğer sayfada stok seçim alanı varsa doldur
                if ($('#id_stok').length > 0) {
                    // Select2 varsa
                    if ($('#id_stok').hasClass('select2-hidden-accessible')) {
                        var newOption = new Option(stok.kod + ' - ' + stok.ad, stok.id, true, true);
                        $('#id_stok').append(newOption).trigger('change');
                    } else {
                        // Normal select
                        $('#id_stok').val(stok.id);
                    }
                }

                // Stok arama inputu varsa (text input)
                if ($('[name="stok_ara"], [name="arama"]').length > 0) {
                    $('[name="stok_ara"], [name="arama"]').val(stok.ad);
                }

                // Modal'ı kapat
                selectedStokIndex = -1;
                globalStokSearchModal.hide();
                // Biraz bekleyip modal'ı kapat
                setTimeout(function () {
                    $('#globalStokSearchModal').modal('hide');
                    selectedStokIndex = -1;
                }, 100);
            });

            // Stok modal açıldığında input'a focus
            document.getElementById('globalStokSearchModal').addEventListener('shown.bs.modal', function () {
                $('#globalStokSearchInput').focus();
            });

            // Enter ve yön tuşları için keydown eventi
            $('#globalStokSearchInput').on('keydown', function (e) {
                var items = $('.stok-select-item');

                if (e.which === 13) { // Enter
                    e.preventDefault();
                    if (selectedStokIndex >= 0 && items.length > 0) {
                        items.eq(selectedStokIndex).click();
                    } else if (items.length > 0) {
                        items.first().click();
                    }
                } else if (e.which === 38) { // Yukarı ok
                    e.preventDefault();
                    if (selectedStokIndex > 0) {
                        selectedStokIndex--;
                        updateStokSelection(items);
                    }
                } else if (e.which === 40) { // Aşağı ok
                    e.preventDefault();
                    if (selectedStokIndex < items.length - 1) {
                        selectedStokIndex++;
                        updateStokSelection(items);
                    }
                }
            });

            // Seçimi güncelle
            function updateStokSelection(items) {
                items.removeClass('active');
                if (selectedStokIndex >= 0) {
                    items.eq(selectedStokIndex).addClass('active');
                    // Görünür alanda tut
                    var container = $('#globalStokSearchResults');
                    var item = items.eq(selectedStokIndex);
                    var itemTop = item.position().top;
                    var itemBottom = itemTop + item.outerHeight();
                    var containerHeight = container.height();
                    var scrollTop = container.scrollTop();

                    if (itemBottom > containerHeight) {
                        container.scrollTop(scrollTop + itemBottom - containerHeight);
                    } else if (itemTop < 0) {
                        container.scrollTop(scrollTop + itemTop);
                    }
                }
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>